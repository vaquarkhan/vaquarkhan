//     jquery-comments.js 1.1.1

//     (c) 2016 Joona Tykkyläinen, Viima Solutions Oy
//     jquery-comments may be freely distributed under the MIT license.
//     For all details and documentation:
//     http://viima.github.io/jquery-comments/

!function(e){"function"==typeof define&&define.amd?define(["jquery"],e):"object"==typeof module&&module.exports?module.exports=function(t,n){return void 0===n&&(n="undefined"!=typeof window?require("jquery"):require("jquery")(t)),e(n),n}:e(jQuery)}(function(e){var t={$el:null,commentsById:{},currentSortKey:"",options:{profilePictureURL:"",currentUserIsAdmin:!1,spinnerIconURL:"",upvoteIconURL:"",reportAbuseIconURL:"",replyIconURL:"",uploadIconURL:"",attachmentIconURL:"",fileIconURL:"",noCommentsIconURL:"",reportAbuseURL:"",textareaPlaceholderText:"Add a comment",newestText:"Newest",oldestText:"Oldest",popularText:"Popular",attachmentsText:"Attachments",sendText:"Send",replyText:"Reply",reportAbuseText:"Report Abuse",commentText:"Comment",reportAbuseUserCommentText:"--- Add any comments below this line ---",postByText:"Posted by {1} on {2}",editText:"Edit",editedText:"Edited",youText:"You",saveText:"Save",deleteText:"Delete",viewAllRepliesText:"View all __replyCount__ replies",hideRepliesText:"Hide replies",noCommentsText:"No comments",noAttachmentsText:"No attachments",attachmentDropText:"Drop files here",textFormatter:function(e){return e},enableReplying:!0,enableEditing:!0,enableUpvoting:!0,enableReportAbusing:!1,enableDeleting:!0,enableAttachments:!1,enableDeletingCommentWithReplies:!1,enableNavigation:!0,postCommentOnEnter:!1,forceResponsive:!1,readOnly:!1,defaultNavigationSortKey:"newest",highlightColor:"#2793e6",deleteButtonColor:"#C9302C",roundProfilePictures:!1,textareaRows:2,textareaRowsOnFocus:2,textareaMaxRows:5,maxRepliesVisible:2,fieldMappings:{id:"id",parent:"parent",created:"created",modified:"modified",content:"content",file:"file",fileURL:"file_url",fileMimeType:"file_mime_type",fullname:"fullname",profileURL:"profile_url",profilePictureURL:"profile_picture_url",createdByAdmin:"created_by_admin",createdByCurrentUser:"created_by_current_user",upvoteCount:"upvote_count",userHasUpvoted:"user_has_upvoted"},getComments:function(e,t){e([])},postComment:function(e,t,n){t(e)},putComment:function(e,t,n){t(e)},deleteComment:function(e,t,n){t()},upvoteComment:function(e,t,n){t(e)},reportAbuseComment:function(e,t,n){t(e)},uploadAttachments:function(e,t,n){t(e)},refresh:function(){},timeFormatter:function(e){return new Date(e).toLocaleDateString()}},events:{click:"closeDropdowns","keydown [contenteditable]":"saveOnKeydown","focus [contenteditable]":"saveEditableContent","keyup [contenteditable]":"checkEditableContentForChange","paste [contenteditable]":"checkEditableContentForChange","input [contenteditable]":"checkEditableContentForChange","blur [contenteditable]":"checkEditableContentForChange","click .navigation li[data-sort-key]":"navigationElementClicked","click .navigation li.title":"toggleNavigationDropdown","click .commenting-field.main .textarea":"showMainCommentingField","click .commenting-field.main .close":"hideMainCommentingField","click .commenting-field .textarea":"increaseTextareaHeight","change .commenting-field .textarea":"increaseTextareaHeight textareaContentChanged","click .commenting-field:not(.main) .close":"removeCommentingField","click .commenting-field .send.enabled":"postComment","click .commenting-field .update.enabled":"putComment","click .commenting-field .delete.enabled":"deleteComment",'change .commenting-field .upload.enabled input[type="file"]':"fileInputChanged","click li.comment button.upvote":"upvoteComment","click li.comment button.reportAbuse":"reportAbuseComment","click li.comment button.delete.enabled":"deleteComment","click li.comment ul.child-comments .toggle-all":"toggleReplies","click li.comment button.reply":"replyButtonClicked","click li.comment button.edit":"editButtonClicked",dragenter:"showDroppableOverlay","dragenter .droppable-overlay":"handleDragEnter","dragleave .droppable-overlay":"handleDragLeaveForOverlay","dragenter .droppable-overlay .droppable":"handleDragEnter","dragleave .droppable-overlay .droppable":"handleDragLeaveForDroppable","dragover .droppable-overlay":"handleDragOverForOverlay","drop .droppable-overlay":"handleDrop"},init:function(t,n){this.$el=e(n),this.$el.addClass("jquery-comments"),this.undelegateEvents(),this.delegateEvents(),function(e){(jQuery.browser=jQuery.browser||{}).mobile=/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4))}(navigator.userAgent||navigator.vendor||window.opera),e.browser.mobile&&this.$el.addClass("mobile"),t.fieldMappings&&(t=e.extend({},t),e.extend(this.options.fieldMappings,t.fieldMappings),delete t.fieldMappings),e.extend(this.options,t),this.options.readOnly&&this.$el.addClass("read-only"),this.currentSortKey=this.options.defaultNavigationSortKey,this.createCssDeclarations(),this.fetchDataAndRender()},delegateEvents:function(){this.bindEvents(!1)},undelegateEvents:function(){this.bindEvents(!0)},bindEvents:function(t){var n=t?"off":"on";for(var a in this.events){var i=a.split(" ")[0],o=a.split(" ").slice(1).join(" "),r=this.events[a].split(" ");for(var s in r)if(r.hasOwnProperty(s)){var l=this[r[s]];l=e.proxy(l,this),""==o?this.$el[n](i,l):this.$el[n](i,o,l)}}},fetchDataAndRender:function(){var t=this;this.$el.empty(),this.createHTML(),this.commentsById={};var n=function(n){var a=n.map(function(e){return t.createCommentModel(e)});t.sortComments(a,"oldest"),e(a).each(function(e,n){t.addCommentToDataModel(n)}),t.render()},a=function(){n([])};this.options.getComments(n,a)},fetchNext:function(){var t=this,n=this.createSpinner();this.$el.find("ul#comment-list").append(n);var a=function(a){e(a).each(function(e,n){t.createComment(n)}),n.remove()},i=function(){n.remove()};this.options.getComments(a,i)},createCommentModel:function(e){var t=this.applyInternalMappings(e);return t.childs=[],t},addCommentToDataModel:function(e){if(!(e.id in this.commentsById)&&(this.commentsById[e.id]=e,e.parent)){var t=this.getOutermostParent(e.parent);t.childs.push(e.id)}},updateCommentModel:function(t){e.extend(this.commentsById[t.id],t)},render:function(){this.showActiveContainer(),this.createComments(),this.options.enableAttachments&&this.createAttachments(),this.$el.find("> .spinner").remove(),this.options.refresh()},showActiveContainer:function(){var e=this.$el.find(".navigation li[data-container-name].active"),t=e.data("container-name"),n=this.$el.find('[data-container="'+t+'"]');n.siblings("[data-container]").hide(),n.show()},createComments:function(){var t=this;this.$el.find("#comment-list").remove();var n=e("<ul/>",{id:"comment-list","class":"main"}),a=[],i=[];e(this.getComments()).each(function(e,t){null==t.parent?a.push(t):i.push(t)}),this.sortComments(a,this.currentSortKey),a.reverse(),e(a).each(function(e,a){t.addComment(a,n)}),this.sortComments(i,"oldest"),e(i).each(function(e,a){t.addComment(a,n)}),this.$el.find('[data-container="comments"]').prepend(n)},createAttachments:function(){var t=this;this.$el.find("#attachment-list").remove();var n=e("<ul/>",{id:"attachment-list","class":"main"}),a=this.getAttachments();this.sortComments(a,"newest"),a.reverse(),e(a).each(function(e,a){t.addAttachment(a,n)}),this.$el.find('[data-container="attachments"]').prepend(n)},addComment:function(e,t){t=t||this.$el.find("#comment-list");var n=this.createCommentElement(e);if(e.parent){var a=t.find('.comment[data-id="'+e.parent+'"]');this.reRenderCommentActionBar(e.parent);var i=a.parents(".comment").last();0==i.length&&(i=a);var o=i.find(".child-comments"),r=o.find(".commenting-field");r.length?r.before(n):o.append(n),this.updateToggleAllButton(i)}else t.prepend(n)},addAttachment:function(e,t){t=t||this.$el.find("#attachment-list");var n=this.createCommentElement(e);t.prepend(n)},removeComment:function(t){var n=this,a=this.commentsById[t],i=this.getChildComments(a.id);if(e(i).each(function(e,t){n.removeComment(t.id)}),a.parent){var o=this.getOutermostParent(a.parent),r=o.childs.indexOf(a.id);o.childs.splice(r,1)}delete this.commentsById[t];var s=this.$el.find('li.comment[data-id="'+t+'"]'),l=s.parents("li.comment").last();s.remove(),this.updateToggleAllButton(l)},uploadAttachments:function(t,n){var a=this;n||(n=this.$el.find(".commenting-field.main"));var i=!n.hasClass("main"),o=t.length;if(o){var r=n.find(".upload"),s=n.find(".textarea");r.removeClass("enabled");var l=this.createSpinner(),d=this.createSpinner();this.$el.find("ul#attachment-list").prepend(l),i?n.before(d):this.$el.find("ul#comment-list").prepend(d);var c=function(t){e(t).each(function(e,t){var n=a.createCommentModel(t);a.addCommentToDataModel(n),a.addComment(n),a.addAttachment(n)}),t.length==o&&0==a.getTextareaContent(s).length&&n.find(".close").trigger("click"),r.addClass("enabled"),d.remove(),l.remove()},p=function(){r.addClass("enabled"),d.remove(),l.remove()},m=[];e(t).each(function(e,t){var n=a.createCommentJSON(s);n.id+="-"+e,n.content="",n.file=t,n.fileURL="C:/fakepath/"+t.name,n.fileMimeType=t.type,n=a.applyExternalMappings(n),m.push(n)}),a.options.uploadAttachments(m,c,p)}r.find("input").val("")},updateToggleAllButton:function(t){var n=t.find(".child-comments"),a=n.find(".comment"),i=n.find("li.toggle-all");a.removeClass("hidden-reply");var o=a.slice(0,-this.options.maxRepliesVisible);if(o.addClass("hidden-reply"),i.find("span.text").text()==this.options.textFormatter(this.options.hideRepliesText)&&o.addClass("visible"),a.length>this.options.maxRepliesVisible){if(!i.length){i=e("<li/>",{"class":"toggle-all highlight-font-bold"});var r=e("<span/>",{"class":"text"}),s=e("<span/>",{"class":"caret"});i.append(r).append(s),n.prepend(i)}this.setToggleAllButtonText(i,!1)}else i.remove()},sortComments:function(e,t){var n=this;"popularity"==t?e.sort(function(e,t){var a=e.childs.length,i=t.childs.length;if(n.options.enableUpvoting&&(a+=e.upvoteCount,i+=t.upvoteCount),i!=a)return i-a;var o=new Date(e.created).getTime(),r=new Date(t.created).getTime();return r-o}):e.sort(function(e,n){var a=new Date(e.created).getTime(),i=new Date(n.created).getTime();return"oldest"==t?a-i:i-a})},sortAndReArrangeComments:function(t){var n=this.$el.find("#comment-list"),a=this.getComments().filter(function(e){return!e.parent});this.sortComments(a,t),e(a).each(function(e,t){var a=n.find("> li.comment[data-id="+t.id+"]");n.append(a)})},showActiveSort:function(){var e=this.$el.find('.navigation li[data-sort-key="'+this.currentSortKey+'"]');this.$el.find(".navigation li").removeClass("active"),e.addClass("active");var t=this.$el.find(".navigation .title");if("attachments"!=this.currentSortKey)t.addClass("active"),t.find("header").html(e.first().html());else{var n=this.$el.find(".navigation ul.dropdown").children().first();t.find("header").html(n.html())}this.showActiveContainer()},forceResponsive:function(){this.$el.addClass("responsive")},closeDropdowns:function(){this.$el.find(".dropdown").hide()},saveOnKeydown:function(t){if(13==t.keyCode){var n=t.metaKey||t.ctrlKey;if(this.options.postCommentOnEnter||n){var a=e(t.currentTarget);a.siblings(".control-row").find(".save").trigger("click"),t.stopPropagation(),t.preventDefault()}}},saveEditableContent:function(t){var n=e(t.currentTarget);n.data("before",n.html())},checkEditableContentForChange:function(t){var n=e(t.currentTarget);n.data("before")!=n.html()&&(n.data("before",n.html()),n.trigger("change"))},navigationElementClicked:function(t){var n=e(t.currentTarget),a=n.data().sortKey;"attachments"!=a&&this.sortAndReArrangeComments(a),this.currentSortKey=a,this.showActiveSort()},toggleNavigationDropdown:function(t){t.stopPropagation();var n=e(t.currentTarget).find("~ .dropdown");n.toggle()},showMainCommentingField:function(t){var n=e(t.currentTarget);n.siblings(".control-row").show(),n.parent().find(".close").show(),n.focus()},hideMainCommentingField:function(t){var n=e(t.currentTarget),a=this.$el.find(".commenting-field.main .textarea"),i=this.$el.find(".commenting-field.main .control-row");this.clearTextarea(a),this.adjustTextareaHeight(a,!1),i.hide(),n.hide(),a.blur()},increaseTextareaHeight:function(t){var n=e(t.currentTarget);this.adjustTextareaHeight(n,!0)},textareaContentChanged:function(t){var n=e(t.currentTarget),a=this.getTextareaContent(n),i=n.siblings(".control-row").find(".save");if(!n.find(".reply-to-badge").length){var o=n.attr("data-comment");if(o){var r=n.parents("li.comment");if(r.length>1){var s=r.last().data("id");n.attr("data-parent",s)}}else{var s=n.parents("li.comment").last().data("id");n.attr("data-parent",s)}}var l=n.parents(".commenting-field").first();n[0].scrollHeight>n.outerHeight()?l.addClass("scrollable"):l.removeClass("scrollable");var d=!0;if(o=n.attr("data-comment")){var c,p=a!=this.commentsById[o].content;this.commentsById[o].parent&&(c=this.commentsById[o].parent.toString());var m=n.attr("data-parent")!=c;d=p||m}a.length&&d?i.addClass("enabled"):i.removeClass("enabled")},removeCommentingField:function(t){var n=e(t.currentTarget),a=n.siblings(".textarea");a.attr("data-comment")&&n.parents("li.comment").first().removeClass("edit");var i=n.parents(".commenting-field").first();i.remove()},postComment:function(t){var n=this,a=e(t.currentTarget),i=a.parents(".commenting-field").first(),o=i.find(".textarea");a.removeClass("enabled");var r=this.createCommentJSON(o);r=this.applyExternalMappings(r);var s=function(e){n.createComment(e),i.find(".close").trigger("click")},l=function(){a.addClass("enabled")};this.options.postComment(r,s,l)},createComment:function(e){var t=this.createCommentModel(e);this.addCommentToDataModel(t),this.addComment(t)},putComment:function(t){var n=this,a=e(t.currentTarget),i=a.parents(".commenting-field").first(),o=i.find(".textarea");a.removeClass("enabled");var r=e.extend({},this.commentsById[o.attr("data-comment")]);e.extend(r,{parent:o.attr("data-parent")||null,content:this.getTextareaContent(o),modified:(new Date).getTime()}),r=this.applyExternalMappings(r);var s=function(e){var t=n.createCommentModel(e);delete t.childs,n.updateCommentModel(t),i.find(".close").trigger("click"),n.reRenderComment(t.id)},l=function(){a.addClass("enabled")};this.options.putComment(r,s,l)},deleteComment:function(t){var n=this,a=e(t.currentTarget),i=a.parents(".comment").first(),o=e.extend({},this.commentsById[i.attr("data-id")]),r=o.id,s=o.parent;a.removeClass("enabled"),o=this.applyExternalMappings(o);var l=function(){n.removeComment(r),s&&n.reRenderCommentActionBar(s)},d=function(){a.addClass("enabled")};this.options.deleteComment(o,l,d)},fileInputChanged:function(t,n){var n=t.currentTarget.files,a=e(t.currentTarget).parents(".commenting-field").first();this.uploadAttachments(n,a)},upvoteComment:function(t){var n,a=this,i=e(t.currentTarget).parents("li.comment").first(),o=i.data().model,r=o.upvoteCount;n=o.userHasUpvoted?r-1:r+1,o.userHasUpvoted=!o.userHasUpvoted,o.upvoteCount=n,this.reRenderUpvotes(o.id);var s=e.extend({},o);s=this.applyExternalMappings(s);var l=function(e){var t=a.createCommentModel(e);a.updateCommentModel(t),a.reRenderUpvotes(t.id)},d=function(){o.userHasUpvoted=!o.userHasUpvoted,o.upvoteCount=r,a.reRenderUpvotes(o.id)};this.options.upvoteComment(s,l,d)},reportAbuseComment:function(t){var n=this,a=e(t.currentTarget).parents("li.comment").first(),i=a.data().model,o=e.extend({},i);o=this.applyExternalMappings(o);var r=function(e){var t=n.createCommentModel(e);n.updateCommentModel(t)},s=function(){};this.options.reportAbuseComment(o,r,s)},toggleReplies:function(t){var n=e(t.currentTarget);n.siblings(".hidden-reply").toggleClass("visible"),this.setToggleAllButtonText(n,!0)},replyButtonClicked:function(t){var n=e(t.currentTarget),a=n.parents("li.comment").last(),i=n.parents(".comment").first().data().id,o=a.find(".child-comments > .commenting-field");o.length&&o.remove();var r=o.find(".textarea").attr("data-parent");if(r!=i){o=this.createCommentingFieldElement(i),a.find(".child-comments").append(o);var s=o.find(".textarea");this.moveCursorToEnd(s)}},editButtonClicked:function(t){var n=e(t.currentTarget),a=n.parents("li.comment").first(),i=a.data().model;a.addClass("edit");var o=this.createCommentingFieldElement(i.parent,i.id);a.find(".comment-wrapper").first().append(o);var r=o.find(".textarea");r.attr("data-comment",i.id),r.append(this.getTextareaContentAsEscapedHTML(i.content)),this.moveCursorToEnd(r)},showDroppableOverlay:function(e){this.options.enableAttachments&&(this.$el.find(".droppable-overlay").css("top",this.$el[0].scrollTop),this.$el.find(".droppable-overlay").show(),this.$el.addClass("drag-ongoing"))},handleDragEnter:function(t){var n=e(t.currentTarget).data("dnd-count")||0;n++,e(t.currentTarget).data("dnd-count",n),e(t.currentTarget).addClass("drag-over")},handleDragLeave:function(t,n){var a=e(t.currentTarget).data("dnd-count");a--,e(t.currentTarget).data("dnd-count",a),0==a&&(e(t.currentTarget).removeClass("drag-over"),n&&n())},handleDragLeaveForOverlay:function(e){var t=this;this.handleDragLeave(e,function(){t.hideDroppableOverlay()})},handleDragLeaveForDroppable:function(e){this.handleDragLeave(e)},handleDragOverForOverlay:function(e){e.stopPropagation(),e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="copy"},hideDroppableOverlay:function(){this.$el.find(".droppable-overlay").hide(),this.$el.removeClass("drag-ongoing")},handleDrop:function(t){t.preventDefault(),e(t.target).trigger("dragleave"),this.hideDroppableOverlay(),this.uploadAttachments(t.originalEvent.dataTransfer.files)},createHTML:function(){var t=this.createCommentingFieldElement();t.addClass("main"),this.$el.append(t);var n=t.find(".control-row");n.hide(),t.find(".close").hide(),this.options.enableNavigation&&(this.$el.append(this.createNavigationElement()),this.showActiveSort());var a=this.createSpinner();this.$el.append(a);var i=e("<div/>",{"class":"data-container","data-container":"comments"});this.$el.append(i);var o=e("<div/>",{"class":"no-comments no-data",text:this.options.textFormatter(this.options.noCommentsText)}),r=e("<i/>",{"class":"fa fa-comments fa-2x"});if(this.options.noCommentsIconURL.length&&(r.css("background-image",'url("'+this.options.noCommentsIconURL+'")'),r.addClass("image")),o.prepend(e("<br/>")).prepend(r),i.append(o),this.options.enableAttachments){var s=e("<div/>",{"class":"data-container","data-container":"attachments"});this.$el.append(s);var l=e("<div/>",{"class":"no-attachments no-data",text:this.options.textFormatter(this.options.noAttachmentsText)}),d=e("<i/>",{"class":"fa fa-paperclip fa-2x"});this.options.attachmentIconURL.length&&(d.css("background-image",'url("'+this.options.attachmentIconURL+'")'),d.addClass("image")),l.prepend(e("<br/>")).prepend(d),s.append(l);var c=e("<div/>",{"class":"droppable-overlay"}),p=e("<div/>",{"class":"droppable-container"}),m=e("<div/>",{"class":"droppable"}),h=e("<i/>",{"class":"fa fa-upload fa-4x"});this.options.uploadIconURL.length&&(h.css("background-image",'url("'+this.options.uploadIconURL+'")'),h.addClass("image"));var u=e("<div/>",{text:this.options.textFormatter(this.options.attachmentDropText)});m.append(h),m.append(u),c.html(p.html(m)).hide(),this.$el.append(c)}},createProfilePictureElement:function(t){if(t)var n=e("<img/>",{src:t,alt:""});else var n=e("<i/>",{"class":"fa fa-user"});return n.addClass("profile-picture"),this.options.roundProfilePictures&&n.addClass("round"),n},createCommentingFieldElement:function(t,n){var a=e("<div/>",{"class":"commenting-field"}),i=this.createProfilePictureElement(this.options.profilePictureURL);i.addClass("by-current-user");var o=e("<div/>",{"class":"textarea-wrapper"}),r=e("<div/>",{"class":"control-row"}),s=e("<div/>",{"class":"textarea","data-placeholder":this.options.textFormatter(this.options.textareaPlaceholderText),contenteditable:!0});this.adjustTextareaHeight(s,!1);var l=e("<span/>",{"class":"close"}).append(e('<span class="left"/>')).append(e('<span class="right"/>'));if(n){var d=this.options.textFormatter(this.options.saveText),c=this.isAllowedToDelete(n);if(c){var p=e("<span/>",{"class":"enabled delete",text:this.options.textFormatter(this.options.deleteText)}).css("background-color",this.options.deleteButtonColor);r.append(p)}}else{var d=this.options.textFormatter(this.options.sendText);if(this.options.enableAttachments){var m=e("<span/>",{"class":"enabled upload"}),h=e("<i/>",{"class":"fa fa-upload"}),u=e("<input/>",{type:"file","data-role":"none"});e.browser.mobile||u.attr("multiple","multiple"),this.options.uploadIconURL.length&&(h.css("background-image",'url("'+this.options.uploadIconURL+'")'),h.addClass("image")),m.append(h).append(u),r.append(m)}}var f=n?"update":"send",g=e("<span/>",{"class":f+" save highlight-background",text:d});if(r.prepend(g),o.append(l).append(s).append(r),a.append(i).append(o),t){s.attr("data-parent",t);var v=this.commentsById[t];if(v.parent){s.html("&nbsp;");var C=e("<input/>",{"class":"reply-to-badge highlight-font-bold",type:"button"}),b="@"+v.fullname;C.val(b),s.prepend(C)}}return a},createNavigationElement:function(){var t=e("<ul/>",{"class":"navigation"}),n=e("<div/>",{"class":"navigation-wrapper"});t.append(n);var a=e("<li/>",{text:this.options.textFormatter(this.options.newestText),"data-sort-key":"newest","data-container-name":"comments"}),i=e("<li/>",{text:this.options.textFormatter(this.options.oldestText),"data-sort-key":"oldest","data-container-name":"comments"}),o=e("<li/>",{text:this.options.textFormatter(this.options.popularText),"data-sort-key":"popularity","data-container-name":"comments"}),r=e("<li/>",{text:this.options.textFormatter(this.options.attachmentsText),"data-sort-key":"attachments","data-container-name":"attachments"}),s=e("<i/>",{"class":"fa fa-paperclip"});this.options.attachmentIconURL.length&&(s.css("background-image",'url("'+this.options.attachmentIconURL+'")'),s.addClass("image")),r.prepend(s);var l=e("<div/>",{"class":"navigation-wrapper responsive"}),d=e("<ul/>",{"class":"dropdown"}),c=e("<li/>",{"class":"title"}),p=e("<header/>");return c.append(p),l.append(c),l.append(d),t.append(l),n.append(a).append(i),d.append(a.clone()).append(i.clone()),(this.options.enableReplying||this.options.enableUpvoting)&&(n.append(o),d.append(o.clone())),this.options.enableAttachments&&(n.append(r),l.append(r.clone())),this.options.forceResponsive&&this.forceResponsive(),t},createSpinner:function(){var t=e("<div/>",{"class":"spinner"}),n=e("<i/>",{"class":"fa fa-spinner fa-spin"});return this.options.spinnerIconURL.length&&(n.css("background-image",'url("'+this.options.spinnerIconURL+'")'),n.addClass("image")),t.html(n),t},createCommentElement:function(t){var n=e("<li/>",{"data-id":t.id,"class":"comment"}).data("model",t);t.createdByCurrentUser&&n.addClass("by-current-user"),t.createdByAdmin&&n.addClass("by-admin");var a=e("<ul/>",{"class":"child-comments"}),i=this.createCommentWrapperElement(t);return n.append(i),null==t.parent&&n.append(a),n},createCommentWrapperElement:function(t){var n=e("<div/>",{"class":"comment-wrapper"}),a=this.createProfilePictureElement(t.profilePictureURL),i=e("<time/>",{text:this.options.timeFormatter(t.created),"data-original":t.created}),o=t.createdByCurrentUser?this.options.textFormatter(this.options.youText):t.fullname,r=e("<div/>",{"class":"name"});if(t.profileURL){var s=e("<a/>",{href:t.profileURL,text:o});r.html(s)}else r.text(o);if((t.createdByCurrentUser||t.createdByAdmin)&&r.addClass("highlight-font-bold"),t.parent){var l=this.commentsById[t.parent];if(l.parent){var d=e("<span/>",{"class":"reply-to",text:l.fullname}),c=e("<i/>",{"class":"fa fa-share"});this.options.replyIconURL.length&&(c.css("background-image",'url("'+this.options.replyIconURL+'")'),c.addClass("image")),d.prepend(c),r.append(d)}}var p=e("<div/>",{"class":"wrapper"}),m=e("<div/>",{"class":"content"}),h=void 0!=t.fileURL;if(h){var u=null,f=null;if(t.fileMimeType){var g=t.fileMimeType.split("/");2==g.length&&(u=g[1],f=g[0])}var s=e("<a/>",{"class":"attachment",href:t.fileURL,target:"_blank"});if("image"==f){var v=e("<img/>",{src:t.fileURL});s.html(v)}else if("video"==f){var C=e("<video/>",{src:t.fileURL,type:t.fileMimeType,controls:"controls"});s.html(C)}else{var b=["archive","audio","code","excel","image","movie","pdf","photo","picture","powerpoint","sound","video","word","zip"],x="fa fa-file-o";b.indexOf(u)>0?x="fa fa-file-"+u+"-o":b.indexOf(f)>0&&(x="fa fa-file-"+f+"-o");var y=e("<i/>",{"class":x});this.options.fileIconURL.length&&(y.css("background-image",'url("'+this.options.fileIconURL+'")'),y.addClass("image"));var T=t.fileURL.split("/"),w=T[T.length-1];w=w.split("?")[0],w=decodeURIComponent(w),s.text(w),s.prepend(y)}m.html(s)}else m.html(this.linkify(this.escape(t.content)));if(t.modified&&t.modified!=t.created){var R=this.options.timeFormatter(t.modified),k=e("<time/>",{"class":"edited",text:this.options.textFormatter(this.options.editedText)+" "+R,"data-original":t.modified});m.append(k)}var U=e("<span/>",{"class":"actions"}),A=e("<span/>",{"class":"separator",text:"·"}),L=e("<button/>",{"class":"action reply",type:"button",text:this.options.textFormatter(this.options.replyText)}),I=e("<i/>",{"class":"fa fa-thumbs-up"});this.options.upvoteIconURL.length&&(I.css("background-image",'url("'+this.options.upvoteIconURL+'")'),I.addClass("image"));var E=this.createUpvoteElement(t),$=e("<i/>",{"class":"fa"});this.options.reportAbuseIconURL.length&&($.css("background-image",'url("'+this.options.reportAbuseIconURL+'")'),$.addClass("image"));var D=this.createReportAbuseElement(t);if(this.options.enableReplying&&U.append(L),this.options.enableUpvoting&&U.append(E),t.createdByCurrentUser||this.options.currentUserIsAdmin)if(h&&this.isAllowedToDelete(t.id)){var M=e("<button/>",{"class":"action delete enabled",text:this.options.textFormatter(this.options.deleteText)});U.append(M)}else if(!h&&this.options.enableEditing){var F=e("<button/>",{"class":"action edit",text:this.options.textFormatter(this.options.editText)});U.append(F)}return this.options.enableReportAbusing&&!t.createdByCurrentUser&&U.append(D),U.children().each(function(t,n){e(n).is(":last-child")||e(n).after(A.clone())}),p.append(m),p.append(U),n.append(a).append(i).append(r).append(p),n},createUpvoteElement:function(t){var n=e("<i/>",{"class":"fa fa-thumbs-up"});this.options.upvoteIconURL.length&&(n.css("background-image",'url("'+this.options.upvoteIconURL+'")'),n.addClass("image"));var a=e("<button/>",{"class":"action upvote"+(t.userHasUpvoted?" highlight-font":"")}).append(e("<span/>",{text:t.upvoteCount,"class":"upvote-count"})).append(n);return a},createReportAbuseElement:function(t){var n=e("<i/>",{"class":"fa"});this.options.reportAbuseIconURL.length&&(n.css("background-image",'url("'+this.options.reportAbuseIconURL+'")'),n.addClass("image"));var a=this.options.reportAbuseURL+"&referingURL="+encodeURIComponent(window.location.href)+"&mymessage="+encodeURIComponent(this.options.commentText+": ")+encodeURIComponent(t.content)+"%0D"+encodeURIComponent(this.options.postByText.replace(/\{1\}/,t.fullname).replace(/\{2\}/,this.options.timeFormatter(t.modified)).replace(/<.*?>/g,"").substring(0,150))+"%0D%0D"+encodeURIComponent(this.options.reportAbuseUserCommentText),i=e("<a/>",{"class":"action reply",href:a,target:"_blank",text:this.options.textFormatter(this.options.reportAbuseText)}).append(n);return i},reRenderComment:function(t){var n=this.commentsById[t],a=this.$el.find('li.comment[data-id="'+n.id+'"]'),i=this;a.each(function(t,a){var o=i.createCommentWrapperElement(n);e(a).find(".comment-wrapper").first().replaceWith(o)})},reRenderCommentActionBar:function(t){var n=this.commentsById[t],a=this.$el.find('li.comment[data-id="'+n.id+'"]'),i=this;a.each(function(t,a){var o=i.createCommentWrapperElement(n);e(a).find(".actions").first().replaceWith(o.find(".actions"))})},reRenderUpvotes:function(t){var n=this.commentsById[t],a=this.$el.find('li.comment[data-id="'+n.id+'"]'),i=this;a.each(function(t,a){var o=i.createUpvoteElement(n);e(a).find(".upvote").first().replaceWith(o)})},createCssDeclarations:function(){e("head style.jquery-comments-css").remove(),this.createCss(".jquery-comments ul.navigation li.active:after {background: "+this.options.highlightColor+" !important;",NaN),this.createCss(".jquery-comments ul.navigation ul.dropdown li.active {background: "+this.options.highlightColor+" !important;",NaN),this.createCss(".jquery-comments .highlight-background {background: "+this.options.highlightColor+" !important;",NaN),this.createCss(".jquery-comments .highlight-font {color: "+this.options.highlightColor+" !important;}"),this.createCss(".jquery-comments .highlight-font-bold {color: "+this.options.highlightColor+" !important;font-weight: bold;}")},createCss:function(t){var n=e("<style/>",{type:"text/css","class":"jquery-comments-css",text:t});e("head").append(n)},getComments:function(){var e=this;return Object.keys(this.commentsById).map(function(t){return e.commentsById[t]})},getChildComments:function(e){return this.getComments().filter(function(t){return t.parent==e})},getAttachments:function(){return this.getComments().filter(function(e){return void 0!=e.fileURL})},getOutermostParent:function(e){var t=e;do{var n=this.commentsById[t];t=n.parent}while(null!=n.parent);return n},createCommentJSON:function(e){var t=(new Date).toISOString(),n={id:"c"+(this.getComments().length+1),parent:e.attr("data-parent")||null,created:t,modified:t,content:this.getTextareaContent(e),fullname:this.options.textFormatter(this.options.youText),profilePictureURL:this.options.profilePictureURL,createdByCurrentUser:!0,upvoteCount:0,userHasUpvoted:!1};return n},isAllowedToDelete:function(t){if(this.options.enableDeleting){var n=!0;return this.options.enableDeletingCommentWithReplies||e(this.getComments()).each(function(e,a){a.parent==t&&(n=!1)}),n}return!1},setToggleAllButtonText:function(e,t){var n=this,a=e.find("span.text"),i=e.find(".caret"),o=function(){var t=n.options.textFormatter(n.options.viewAllRepliesText),i=e.siblings(".comment").length;t=t.replace("__replyCount__",i),a.text(t)},r=this.options.textFormatter(this.options.hideRepliesText);t?(a.text()==r?o():a.text(r),i.toggleClass("up")):a.text()!=r&&o()},adjustTextareaHeight:function(t,n){var a=2.2,i=1.45,o=function(e){var n=a+(e-1)*i;t.css("height",n+"em")};t=e(t);var r=1==n?this.options.textareaRowsOnFocus:this.options.textareaRows;do{o(r),r++;var s=t[0].scrollHeight>t.outerHeight(),l=0==this.options.textareaMaxRows?!1:r>this.options.textareaMaxRows;
}while(s&&!l)},clearTextarea:function(e){e.empty().trigger("input")},getTextareaContent:function(t){var n=e("<pre/>").html(t.html());n.find("div, p, br").replaceWith(function(){return"\n"+this.innerHTML});var a=n.text().replace(/^\s+/g,"");return a},getTextareaContentAsEscapedHTML:function(e){var t=this.escape(e);return t.replace(/(?:\n)/g,"<br>")},moveCursorToEnd:function(t){if(t=e(t)[0],e(t).trigger("input"),e(t).scrollTop(t.scrollHeight),"undefined"!=typeof window.getSelection&&"undefined"!=typeof document.createRange){var n=document.createRange();n.selectNodeContents(t),n.collapse(!1);var a=window.getSelection();a.removeAllRanges(),a.addRange(n)}else if("undefined"!=typeof document.body.createTextRange){var i=document.body.createTextRange();i.moveToElementText(t),i.collapse(!1),i.select()}t.focus()},escape:function(t){return e("<pre/>").text(t).html()},linkify:function(e){var t,n,a,i;n=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,t=e.replace(n,'<a href="$1" target="_blank">$1</a>'),a=/(^|[^\/f])(www\.[\S]+(\b|$))/gim,t=t.replace(a,'$1<a href="http://$2" target="_blank">$2</a>'),i=/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim,t=t.replace(i,'<a href="mailto:$1">$1</a>');var o=e.match(/<a href/g)||[];if(o.length>0){for(var r=e.split(/(<\/a>)/g),s=0;s<r.length;s++)null==r[s].match(/<a href/g)&&(r[s]=r[s].replace(n,'<a href="$1" target="_blank">$1</a>').replace(a,'$1<a href="http://$2" target="_blank">$2</a>').replace(i,'<a href="mailto:$1">$1</a>'));var l=r.join("");return l}return t},applyInternalMappings:function(e){var t={},n=this.options.fieldMappings;for(var a in n)n.hasOwnProperty(a)&&(t[n[a]]=a);return this.applyMappings(t,e)},applyExternalMappings:function(e){var t=this.options.fieldMappings;return this.applyMappings(t,e)},applyMappings:function(e,t){var n={};for(var a in t)if(a in e){var i=e[a];n[i]=t[a]}return n}};e.fn.comments=function(n){return this.each(function(){var a=Object.create(t);a.init(n||{},this),e.data(this,"comments",a)})}});